# 第 2 章 URL 与资源

所有的东西都有一个标准化的名字，以帮助人们寻找城市中的各种资源。 比如你的身份证号码，只要知道了你的身份证号码，也就知道了你是谁。

而 URL 就是因特网资源的标准化名称。URL 指向一条条电子信息片段，告诉你它们位于何处，以及如何与之进行交互。 

## 2.1 浏览因特网资源 

URL 是浏览器寻找信息时所需的资源位置。通过 URL，人类和应用程序才能找到、使用并共享因特网上大量的数据资源。URL 是人们对 HTTP 和其他协议的常用访问点：一个人将浏览器指一个 URL，浏览器就会在幕后发送适当的协议报文来获取人们所期望的资源。 

HTTP 规范将更通用的概念 URI 作为其资源标识符，但实际上，HTTP 应用程序处理的只是 URI 的 URL 子集。 

比如你想要获取 https://www.hushaby.com/main/index.html。那么 URL 分为以下三部分

1. URL 第一部分（https）就是 URL 方案。告知 Web 客户端怎样访问资源。
2. URL 的第二部分（www.hushaby.com）就是指服务器的位置。这部分告知 Web 客户端资源位于何处。
3. URL 的第三部分（/main/index.html）就是资源路径。路径说明了请求的是服务器上哪个特定的本地资源。 

### 2.2 URL 的语法

大多数 URL 方案的 URL 语法都建立在这个由 9 部分构成的通用格式上： 

```
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>
```

几乎没有哪个 URL 中包含了所有这些组件。**URL 最重要的 3 个部分是方案（scheme）、主机（host）和路径（path）**。 

请看下表所示：

| 组件   | 描述                                       | 默认值       |
| ---- | ---------------------------------------- | --------- |
| 方案   | 访问服务器以获取资源时要使用哪种协议。                      | 无         |
| 用户   | 某些方案访问资源时需要的用户名。                         | 匿名        |
| 密码   | 用户名后面可能要包含的密码，中间由冒号（:）分隔。                | E-mail 地址 |
| 主机   | 资源宿主服务器的主机名或点分IP地址。                      | 无         |
| 端口   | 资源宿主服务器正在监听的端口号。很多方案都有默认端口号（HTTP的默认端口号为80）。 | 每个方案特有    |
| 路径   | 服务器上资源的本地名，由一个斜杠（/）将其与前面的URL组件分隔开来。路径组件的语法是与服务器和方案有关的（本章稍后会讲到URL路径可以分为若干个段，每段都可以有其特有的组件）。 | 无         |
| 参数   | 某些方案会用这个组件来指定输入参数。参数为名/值对。URL中可以包含多个参数字段，它们相互之间以及与路径的其余部分之间用分号（;）分隔。 | 无         |
| 查询   | 某些方案会用这个组件传递参数以激活应用程序（比如数据库、公告板、搜索引擎以及其他因特网网关）。查询组件的内容没有通用格式。用字符问号（?）将其与URL的其余部分分隔开来。 | 无         |
| 片段   | 一小片或一部分资源的名字。引用对象时，不会将frag字段传送给服务器；这个字段是在客户端内部使用的。通过字符“#”将其与URL的其余部分分隔开来。 | 无         |

### 2.2.1 方案 —— 使用什么协议 

方案实际上是规定如何访问指定资源的主要标识符，它会告诉负责解析 URL 的应用程序应该使用什么协议。在我们这个简单的 HTTP URL 中所使用的方案就是 https。 

方案组件必须以一个字母符号开始，由第一个 ":" 符号将其与 URL 的其余部分分隔开来。方案名是大小写无关的。

### 2.2.2 主机与端口 

要想在因特网上找到资源，应用程序要知道是哪台机器装载了资源，以及在那台机器的什么地方可以找到能对目标资源进行访问的服务器。URL 的主机和端口组件提供了这两组信息。  

主机组件标识了因特网上能够访问资源的宿主机器。可以用主机名或 IP 地址来表示主机名。 

端口组件标识了服务器正在监听的网络端口。对下层使用了 TCP 协议的 HTTP 来说，默认的端口号为 80。

### 2.2.3 用户名和密码 

更有趣的组件是用户和密码组件。很多服务器都要求输入用户名和密码才会允许用户访问数据。FTP 服务器就是这样一个常见的实例。 

目前使用的很少了。

### 2.2.4 路径

URL 的路径组件说明了资源位于服务器的什么地方。路径通常很像一个分级的文件系统路径。路径是服务器定位资源时所需的信息。  

### 2.2.5 参数 

对很多方案来说，只有简单的主机名和到达对象的路径是不够的。除了服务器正在监听的端口，以及是否能够通过用户名和密码访问资源外，很多协议都还需要更多的信息才能工作。 

负责解析 URL 的应用程序需要这些协议参数来访问资源。 

为了向应用程序提供它们所需的输入参数，以便正确地与服务器进行交互，URL 中有一个参数组
件。这个组件就是 URL 中的名值对列表，由字符 ";" 将其与 URL 的其余部分（以及各名值对）分隔开来。它们为应用程序提供了访问资源所需的所有附加信息。 

比如：

```
ftp://prep.ai.mit.edu/pub/gnu;type=d
```

在这个例子中，有一个参数 type=d，参数名为 type，值为 d。 

### 2.2.6 查询字符串 

很多资源，比如数据库服务，都是可以通过提问题或进行查询来缩小所请求资源类型范围的。 

URL 的查询组件和标识网关资源的 URL 路径组件一起被发送给网关资源。基本上可以将网关当作访问其他应用程序的访问点。

使用 "?" 来进行查询。

### 2.2.7 片段 

有些资源类型，比如 HTML，除了资源级之外，还可以做进一步的划分。比如，对一个带有章节的大型文本文档来说，资源的 URL 会指向整个文本文档，但理想的情况是，能够指定资源中的那些章节。

为了引用部分资源或资源的一个片段，URL 支持使用片段（frag）组件来表示一个资源内部的片段。
比如，URL 可以指向 HTML 文档中一个特定的图片或小节。 

片段挂在 URL 的右手边，最前面有一个字符“#”。

但需要注意，HTTP 服务器通常只处理整个对象，而不是对象的片段，客户端不能将片段传送给服务器。浏览器从服务器获得了整个资源之后，会根据片段来显示你感兴趣的那部分资源。 

## 2.3 URL 快捷方式 

Web 客户端可以理解并使用几种 URL 快捷方式。相对 URL 是在某资源内部指定一个资源的便捷缩略方式。 

很多浏览器还支持 URL 的“自动扩展”，也就是用户输入 URL 的一个关键（可记忆的）部
分，然后由浏览器将其余部分填充起来。 

### 2.3.1 相对URL 

URL 有两种方式：绝对的和相对的。

到目前为止，我们只见过绝对URL。绝对 URL 中包含有访问资源所需的全部信息。 

另一方面，相对 URL 是不完整的。要从相对 URL 中获取访问资源所需的全部信息，就必须相对于另一个，被称为其基础（base）的 URL 进行解析。 

相对 URL 是 URL 的一种便捷缩略记法。如果你手工写过 HTML 的话，可能就会发现相对 URL 是多么便捷了。 

还需要注意的是，相对URL为保持一组资源（比如一些HTML页面）的可移植性提供了一种便捷方式 。如果使用的是相对 URL，就可以在搬移一组文档的同时，仍然保持链接的有效性，因为相对URL 都是相对于新基础进行解释的。这样就可以实现在其他服务器上提供镜像内容之类的功能了。 

1. 基础URL 

   转换处理的第一步就是找到基础 URL。基础 URL 是作为相对 URL 的参考点使用的。可以来自以下几个不同的地方。 

   - **在资源中显式提供** 

     有些资源会显式地指定基础 URL。比如，HTML 文档中可能会包含一个定义了基础 URL的 HTML 标记 < BASE >，通过它来转换那个 HTML 文档中的所有相对 URL。 

   - **封装资源的基础 URL** 

     如果在一个没有显式指定基础 URL 的资源中发现了一个相对 URL。

   - **没有基础 URL** 

     在某些情况下，没有基础 URL。这通常意味着你有一个相对 URL；但有时可能只是一个不完整或损坏了的 URL。 

2. 解析相对引用 

   前面我们介绍了 URL 的基本组件和语法。要将相对 URL 转换为一个绝对 URL，下一步要做的就是将相对 URL 和基础 URL 划分成组件段。 

   实际上，这样只是在解析 URL，但这种做法会将其划分成一个个组件，因此通常会称作分解（decomposing）URL。只要将基础和相对 URL 划分成了组件。 

这个算法将一个相对 URL 转换成了其绝对模式，之后就可以用它来引用资源了。 

### 2.3.2 自动扩展URL 

有些浏览器会在用户提交 URL 之后，或者在用户输入的时候尝试着自动扩展 URL。这就为用户提供了一条捷径：用户不需要输入完整的 URL，因为浏览器会自动扩展。 

## 2.4 各种令人头疼的字符 

URL 是可移植的（portable）。它要统一地命名因特网上所有的资源，这也就意味着要通过各种不同的协议来传送这些资源。这些协议在传输数据时都会使用不同的机制，所以，设计 URL，使其可以通过任意因特网协议安全地传输是很重要的。 

安全传输意味着 URL 的传输不能丢失信息。有些协议，比如传输电子邮件的简单邮件传输协议（Simple Mail Transfer Protocol，SMTP），所使用的传输方法就会剥去一些特定的符。为了避开这些问题，URL 只能使用一些相对较小的、通用的安全字母表中的字符。 

本节总结了 URL 的通用字母表和编码规则。 

### 2.4.1 URL 字符集

默认的计算机系统字符集通常都倾向于以英语为中心。从历史上来看，很多计算机应用程序使用的都是 US-ASCII 字符集。US-ASCII 使用 7 位二进制码来表示英文打字机提供的大多数按键和少数用于文本格式和硬件通知的不可打印控制字符。 

由于 US-ASCII 的历史悠久，所以其可移植性很好。但是，虽然美国用户使用起来很便捷，它却并不支持在各种欧洲语言或全世界数十亿人使用的数百种非罗马语言中很常见的变体字符。 

而且，有些 URL 中还会包含任意的二进制数据。认识到对完整性的需求之后，URL 的设计者就将转义序列集成了进去。通过转义序列，就可以用 US-ASCII 字符集的有限子集对任意字符值或数据进行编码了，这样就实现了可移植性和完整性。 

### 2.4.2 编码机制 

为了避开安全字符集表示法带来的限制，人们设计了一种编码机制，用来在 URL 中表示各种不安全的字符。这种编码机制就是通过一种“转义”表示法来表示不安全字符的，这种转义表示法包含一个百分号（%），后面跟着两个表示字符 ASCII 码的 十六进制数。 

一些编码字符示例：

| 字符   | ASCII 码   | URL                                      |
| ---- | --------- | ---------------------------------------- |
| ~    | 126(0x7E) | http://www.joes-hardware.com/%7Ejoe      |
| 空格   | 32(0x20)  | http://www.joes-hardware.com/more%20tools.html |
| %    | 37(0x25)  | http://www.joes-hardware.com/100%25satisfaction.html |

### 2.4.3 字符限制 

在 URL 中，有几个字符被保留起来，有着特殊的含义。有些字符不在定义的US-ASCII 可打印字符集中。还有些字符会与某些因特网网关和协议产生混淆，因此不赞成使用。 

下表列出了一些字符，在将其用于保留用途之外的场合时，要在 URL 中对其进行编码。 

| 字符                 |                                          |
| ------------------ | ---------------------------------------- |
| %                  | 保留作为编码字符的转义标志                            |
| /                  | 保留作为路径组件中分隔路径段的定界符                       |
| .                  | 保留在路径组件中使用                               |
| ..                 | 保留在路径组件中使用                               |
| #                  | 保留作为分段定界符使用                              |
| ?                  | 保留作为查询字符串定界符使用                           |
| ;                  | 保留作为参数定界符使用                              |
| :                  | 保留作为方案、用户/口令，以及主机/端口组件的定界符使用             |
| $,+                | 保留                                       |
| @ & =              | 在某些方案的上下文中有特殊的含义，保留                      |
| { } \| \ ^ ~ [ ] ' | 由于各种传输Agent代理，比如各种网关的不安全处理，使用受限          |
| < > "              | 不安全；这些字符在URL范围之外通常是有意义的，比如在文档中对URL自身进行定界 |
| 0x00-0x1F, 0x7F    | 受限，这些十六进制范围内的字符都在US-ASCII字符集的不可打印区间内     |
| 0x7F               | 受限，十六进制值在此范围内的字符都不在US-ASCII字符集的7比特范围内    |

### 2.4.4 另外一点说明

你可能会感到奇怪，为什么使用一些不安全字符的时候并没有发生什么不好的事情。 

对某些传输协议来说，这并不是什么问题，但对应用程序开发人员来说，对非安全字符进行编码仍然是明智的。 

应用程序要按照一定规范工作。客户端应用程序在向其他应用程序发送任意 URL 之前，最好把所有不安全或受限字符都进行转换。只要对所有不安全字符都进行了编码，这个 URL 就是可在各应用程序之间共享的规范形式；也就无需操心其他应用程序会被字符的任何特殊含义所迷惑了。 

有时，有些人会恶意地对额外的字符进行编码，以绕过那些对 URL 进行模式匹配的应用程序——比如，Web 过滤程序。对安全的 URL 组件进行编码会使模式匹配程序无法识别出它们所要搜寻的模式。总之，解释 URL 的应用程序必须在处理 URL 之前对其进行解码。 

